{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos | VGLuxeBeauty</title>
    <link rel="stylesheet" href="{% static 'css/productos.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}">
    <link rel="stylesheet" href="{% static 'css/ui-utils.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap"  rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    {% include 'partials/header.html' %}
    <main class="productos-page">
        <!-- Header -->
         <div class="productos-header">
            <h1>Productos</h1>
            <p>Descubre nuestra exclusiva selección de productos de belleza</p>
        </div>

        <!-- Filtros y Ordenamiento-->
         <div class="filtros-container">
            <div class="filtros-categorias">
                <a href="{% url 'productos' %}" class="filtro-btn {% if not categoria_actual %}activo{% endif %}">
                Todos
            </a>
            {% for cat in categorias %}
            <a href="?categoria={{ cat }}" class="filtro-btn {% if categoria_actual == cat %}activo{% endif %}">
                {{ cat }}
            </a>
            {% endfor %}
            </div>

            <div class="ordenar-container">
                <label for="ordenar">Ordenar por:</label>
                <select id="ordenar" class="ordenar-select" onchange="ordenarProductos(this.value)">
                    <option value="reciente" {% if orden_actual == 'reciente' %}selected{% endif %}>Más reciente</option>
                    <option value="precio_menor" {% if orden_actual == 'precio_menor' %}selected{% endif %}>Precio: menor a mayor</option>
                    <option value="precio_mayor" {% if orden_actual == 'precio_mayor' %}selected{% endif %}>Precio: mayor a menor</option>
                    <option value="nombre" {% if orden_actual == 'nombre' %}selected{% endif %}>Nombre: A-Z</option>
                </select>
            </div>
        </div>


        <!-- Grid de Productos -->
         {% if productos %}
         <div class="productos-grid">
            {% for producto in productos %}
            <div class="producto-card">
                
                <a href="{% url 'producto_detalle' producto.id %}">
                <div class="producto-imagen">
                    {% if producto.imagen %}
                    
                        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
                    {% else %}
                        <img src="{% static 'images/placeholder.jpg' %}" alt="{{ producto.nombre }}">
                    {% endif %}   
                
                </div>
                </a>
                        
                        
                    
                    <div class="producto-info">
                    <p class="producto-categoria">{{ producto.categoria }}</p>
                    <h3 class="producto-nombre">{{ producto.nombre }}</h3>
                    <p class="producto-precio">${{ producto.precio }}</p>


                    
                    <div class="producto-acciones">
                        <a href="{% url 'producto_detalle' producto.id %}" class="btn-ver-detalle">
                            <i class="bi bi-eye"></i> Ver Detalle
                        </a>
                        {% if producto.stock > 0 %}
                        <form method="post" action="{% url 'agregar_al_carrito' producto.id %}" class="form-agregar-carrito" data-producto-id="{{ producto.id }}">
                            {% csrf_token %}
                            <button type="submit" class="btn-agregar-carrito">
                                <i class="bi bi-cart-plus"></i> Agregar
                            </button>
                        </form>
                        {% else %}
                        <button class="btn-agregar-carrito disabled" disabled>
                            <i class="bi bi-x-circle"></i> Agotado
                        </button>
                        {% endif %}

                    </div>
                </div> 
            </div>
            {% endfor %}
        </div>


        <!-- Paginacion -->
         {% if productos.has_other_pages %}
         <div class="paginacion">
            {% if productos.has_previous %}
                <a href="?page=1{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
                <a href="?page={{ productos.paginator.num_pages }}{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            {% else %}
                <span class="disabled"><i class="bi bi-chevron-right"></i></span>
                <span class="disabled"><i class="bi bi-chevron-double-right"></i></span>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <!--- Sin resultados -->
        <div class="sin-resultados">
            <i class="bi bi-search"></i>
            <h3>No se encontraron productos</h3>
            <p>Intenta con otra búsqueda o categoría.</p>
        </div>
        {% endif %}

        <!-- busqueda -->
         {% if busqueda %}
         <p>Resultados para: "{{ busqueda }}"</p>
        {% endif %}
    </main>
    {% include 'partials/footer.html' %}

    <!-- Notificacion Toast -->
    <div id="toast-notification" class="toast-notification">
        <i class="bi bi-check-circle-fill"></i>
        <span id="toast-message"></span>
    </div>
    
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        function ordenarProductos(orden) {
            const url = new URL(window.location);
            url.searchParams.set('orden', orden);
            window.location = url;
        }

        // Manejar formularios de agregar al carrito con AJAX
        document.addEventListener('DOMContentLoaded', function(){
            const forms = document.querySelectorAll('.form-agregar-carrito');

            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const url = this.action;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData


                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            //Actualizar contador del carrito
                            actualizarContadorCarrito(data.total_items);
                            //Mostrar notificacion
                            mostrarToast(data.message, 'success');
                        } else {
                            mostrarToast(data.message, 'error');
                        }

                })
                .catch(error => {
                        console.error('Error:', error);
                        mostrarToast('Ocurrió un error al agregar el producto al carrito.', 'error');
                    });
                });
            });
        });

        function actualizarContadorCarrito(total) {
            const contador = document.getElementById('carrito-contador');
            if (contador) {
                contador.textContent = total;
                // Animación de rebote
                contador.style.transform = 'scale(1.5)';
                setTimeout(() => {
                    contador.style.transform = 'scale(1)';
                }, 200);
            }
        }
        function mostrarToast(mensaje, tipo) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const icon = toast.querySelector('i');

            toastMessage.textContent = mensaje;

            //Cambiar icono segun el tipo
            if (tipo === 'success') {
                icon.className = 'bi bi-check-circle-fill';
                toast.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else {
                icon.className = 'bi bi-exclamation-triangle-fill';
                toast.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            
            }

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>






            